module.exports=function(){function e(e,t,n){if(t&&e){n=n?n:{};for(var i in m)y[m[i][0]]=i in n?n[i]:m[i][1];x(e),v=new Image,v.addEventListener("load",function(e){this.create()}.bind(this)),v.src=t}}function t(e){var t=u.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;return{x:0>n?0:n>t.width?t.width:n,y:0>i?0:i>t.height?t.height:i}}function n(){var e=u.getBoundingClientRect();l.x<0&&(l.x=0,l.x2=l.w),l.y<0&&(l.y=0,l.y2=l.h),l.x2>e.width&&(l.x2=e.width,l.x=l.x2-l.w),l.y2>e.height&&(l.y2=e.height,l.y=l.y2-l.h),l.w=l.x2-l.x,l.h=l.y2-l.y,s.style.top=l.y+"px",s.style.left=l.x+"px",s.style.width=l.w+"px",s.style.height=l.h+"px",c.setAttribute("d","M 0 0 v"+e.height+"h"+e.width+"v"+-e.height+"H-0zM"+l.x+" "+l.y+"h"+l.w+"v"+l.h+"h-"+l.w+"V-"+l.h+"z"),y.up&&y.up(l)}function i(e){e=t(e),l.x=e.x-.5*l.w,l.y=e.y-.5*l.h,l.x2=e.x+.5*l.w,l.y2=e.y+.5*l.h,n()}function o(e){document.addEventListener("mousemove",r),document.addEventListener("mouseup",d),i(e)}function d(e){document.removeEventListener("mouseup",d),document.removeEventListener("mousemove",r)}function r(e){i(e)}function h(e,i,o){function d(e){e.stopPropagation(),document.addEventListener("mouseup",h),document.addEventListener("mousemove",r)}function r(e){e.stopPropagation(),o(t(e)),n()}function h(e){e.stopPropagation(),document.removeEventListener("mouseup",h),document.removeEventListener("mousemove",r)}var u=document.createElement("span");return u.className="imgc-handles-el-"+e+"-"+i,u.addEventListener("mousedown",d),u}var u,s,c,m={update:["up",!1],create_cb:["cr",!1],destroy_cb:["de",!1],max_width:["mw",500],max_height:["mh",500],fixed_size:["fs",!1]},a=[function(e){a[7](e),a[4](e)},function(e){a[5](e),a[4](e)},function(e){a[5](e),a[6](e)},function(e){a[7](e),a[6](e)},function(e){l.y=l.y2-e.y<32?l.y2-32:e.y},function(e){l.x2=e.x-l.x<32?l.x+32:e.x},function(e){l.y2=e.y-l.y<32?l.y+32:e.y},function(e){l.x=l.x2-e.x<32?l.x2-32:e.x}],p=null,w=!1,l={x:0,y:0,x2:80,y2:80,w:80,h:80},y={},v=null,f={w:1,h:1},x=function(e){u&&this.destroy(),u=document.querySelector(e),u.className+=" imgc ".indexOf(" "+y.cn+" ")>-1?"":" imgc"};return e.prototype.create=function(e){if(!w){u||x(e);var t=v.width,i=v.height;t>y.mw&&(i=~~(y.mw*i/t),t=y.mw),i>y.mh&&(t=~~(y.mh*t/i),i=y.mh),f={w:v.naturalWidth/t,h:v.naturalHeight/i},u.style.width=t+"px",u.style.height=i+"px",u.addEventListener("DOMNodeRemovedFromDocument",this.destroy),p=document.createElement("canvas"),p.setAttribute("width",t),p.setAttribute("height",i),u.appendChild(p),u.appendChild(v);var d=document.createElementNS("http://www.w3.org/2000/svg","svg");d.setAttribute("height",i),d.setAttribute("width",t),u.appendChild(d),c=document.createElementNS("http://www.w3.org/2000/svg","path"),c.style.fill="rgba(0, 0, 0, .8)",d.appendChild(c),s=document.createElement("div"),s.className="imgc-handles",u.appendChild(s);for(var r=0;r<(y.fs?4:8);r++)s.appendChild(new h(y.fs?0:~~(r/4),r%4,a[r]));u.addEventListener("mousedown",o),w=!0,n({x:0,y:0}),y.cr&&y.cr({w:t,h:i})}},e.prototype.destroy=function(){if(w){if(u){for(u.removeEventListener("DOMNodeRemovedFromDocument",this.destroy),u.removeEventListener("mousedown",o);u.firstChild;)u.removeChild(u.firstChild);u=p=v=s=c=null}w=!1,y.de&&y.de()}},e.prototype.crop=function(e,t){(!e||"image/jpeg"!==e&&"image/png"!==e)&&(e="image/jpeg"),(!t||0>t||t>1)&&(t=1),p.setAttribute("width",l.w),p.setAttribute("height",l.h);var n=p.getContext("2d");return n.drawImage(v,f.w*l.x,f.h*l.y,f.w*l.w,f.h*l.h,0,0,l.w,l.h),p.toDataURL(e,t)},e}();