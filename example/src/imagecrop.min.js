module.exports=function(){function e(e,t,n){t&&e&&(b(n),C(e),L=new Image,L.addEventListener("load",function(e){this.create()}.bind(this)),L.src=t)}function t(e){var t=e.clientX-y("left"),n=e.clientY-y("top");return{x:0>t?0:t>y("width")?y("width"):t,y:0>n?0:n>y("height")?y("height"):n}}function n(){f.w=f.w<32?32:f.w,f.h=f.h<32?32:f.h,f.x=f.x<0?0:f.x+f.w>y("width")?y("width")-f.w:f.x,f.y=f.y<0?0:f.y+f.h>y("height")?y("height")-f.h:f.y}function i(){m.style.top=f.y+"px",m.style.left=f.x+"px",m.style.width=f.w+"px",m.style.height=f.h+"px",a.setAttribute("d","M 0 0 v"+y("height")+"h"+y("width")+"v"+-y("height")+"H-0zM"+f.x+" "+f.y+"h"+f.w+"v"+f.h+"h-"+f.w+"V-"+f.h+"z"),E.up&&E.up(f)}function o(e){e=t(e),f.x=e.x-.5*f.w,f.y=e.y-.5*f.h,n(),i()}function h(e){g||(document.addEventListener("mousemove",r),document.addEventListener("mouseup",d),o(e),g=!0)}function d(e){g&&(document.removeEventListener("mouseup",d),document.removeEventListener("mousemove",r),g=!1)}function r(e){g&&o(e)}function u(e,o,h){function d(e){e.stopPropagation(),s=!0,document.addEventListener("mouseup",u),document.addEventListener("mousemove",r)}function r(e){e.stopPropagation(),s&&(h(t(e)),n(),i())}function u(e){e.stopPropagation(),s=!1,document.removeEventListener("mouseup",u),document.removeEventListener("mousemove",r)}var s=!1,h=h,m=e,c=o;this.el=document.createElement("span"),this.el.className="imgc-handles-el-"+m+"-"+c,this.el.addEventListener("mousedown",d)}var s,m,c,a,w={update:["up",!1],create_cb:["cr",!1],destroy_cb:["de",!1],max_width:["mw",500],max_height:["mh",500]},p=[function(e){f.w+=f.x-e.x,f.h+=f.y-e.y,f.x=e.x,f.y=e.y},function(e){f.w=e.x-f.x,f.h+=f.y-e.y,f.y=e.y},function(e){f.w=e.x-f.x,f.h=e.y-f.y},function(e){f.w+=f.x-e.x,f.x=e.x,f.h=e.y-f.y},function(e){f.h+=f.y-e.y,f.y=e.y},function(e){f.w=e.x-f.x},function(e){f.h=e.y-f.y},function(e){f.w+=f.x-e.x,f.x=e.x}],y=function(e){return s.getBoundingClientRect()[e]},l=[],v=null,x=!1,g=!1,f={x:0,y:0,w:80,h:80},E={},L=null,b=function(e){e=e?e:{};for(var t in w)E[w[t][0]]=t in e?e[t]:w[t][1]},C=function(e){s&&this.destroy(),s=document.querySelector(e),s.className+=" imgc ".indexOf(" "+E.cn+" ")>-1?"":" imgc"};return e.prototype.create=function(e){if(!x){s||setParent(e);var t=L.width,n=L.height;t>E.mw&&(n=~~(E.mw*n/t),t=E.mw),n>E.mh&&(t=~~(E.mh*t/n),n=E.mh),s.style.width=t+"px",s.style.height=n+"px",s.addEventListener("DOMNodeRemoved",this.destroy,!1),s.addEventListener("DOMNodeRemovedFromDocument",this.destroy,!1),v=document.createElement("canvas"),v.setAttribute("width",t),v.setAttribute("height",n),s.appendChild(v),s.appendChild(L),L.width=t,L.height=n,c=document.createElementNS("http://www.w3.org/2000/svg","svg"),c.setAttribute("height",y("height")),c.setAttribute("width",y("width")),s.appendChild(c),a=document.createElementNS("http://www.w3.org/2000/svg","path"),a.style.fill="rgba(0, 0, 0, .8)",c.appendChild(a),m=document.createElement("div"),m.className="imgc-handles",s.appendChild(m),l=[];for(var o=0;8>o;o++)l.push(new u(~~(o/4),o%4,p[o])),m.appendChild(l[o].el);s.addEventListener("mousedown",h),x=!0,i(),E.cr&&E.cr(f)}},e.prototype.destroy=function(){if(x){if(s){for(s.removeEventListener("DOMNodeRemoved",this.destroy),s.removeEventListener("DOMNodeRemovedFromDocument",this.destroy),s.removeEventListener("mousedown",h);s.firstChild;)s.removeChild(s.firstChild);s=v=L=m=l=c=a=null}x=!1,E.de&&E.de()}},e.prototype.crop=function(e,t){(!e||"image/jpeg"!==e&&"image/png"!==e)&&(e="image/jpeg"),(!t||0>t||t>1)&&(t=1);var n={x:f.x,y:f.y,w:f.w,h:f.h};v.setAttribute("width",n.w),v.setAttribute("height",n.h);var i=v.getContext("2d");return i.imageSmoothingEnabled=!1,i.drawImage(L,n.x,n.y,n.w,n.h,0,0,n.w,n.h),v.toDataURL(e,t)},e}();